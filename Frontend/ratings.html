<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillBarter - Ratings</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-brand">
                <h1>SkillBarter</h1>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="skills.html">Skills</a></li>
                <li><a href="availability.html">Availability</a></li>
                <li><a href="matching.html">Matching</a></li>
                <li><a href="session.html">Sessions</a></li>
                <li><a href="ratings.html" class="active">Ratings</a></li>
                <li><a href="#" id="logout">Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="ratings-container">
                <h1>Rate Your Session</h1>

                <div class="rating-form">
                    <div class="session-summary">
                        <h2>Session Summary</h2>
                        <div id="session-summary">
                            <!-- Session summary will be populated by JS -->
                        </div>
                    </div>

                    <form id="rating-form">
                        <div class="rating-section">
                            <h3>Rate the Learning Experience</h3>
                            <div class="star-rating">
                                <input type="radio" id="star5" name="rating" value="5">
                                <label for="star5" title="5 stars">★</label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4" title="4 stars">★</label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3" title="3 stars">★</label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2" title="2 stars">★</label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1" title="1 star">★</label>
                            </div>
                        </div>

                        <div class="comment-section">
                            <label for="rating-comment">Comments (Optional)</label>
                            <textarea id="rating-comment" rows="4" placeholder="Share your feedback about the session..."></textarea>
                        </div>

                        <div class="rating-actions">
                            <button type="submit" class="btn btn-primary">Submit Rating</button>
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">Skip for Now</button>
                        </div>
                    </form>
                </div>

                <div class="past-ratings">
                    <h2>Your Past Ratings</h2>
                    <div id="past-ratings">
                        <!-- Past ratings will be populated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/dummy-loader.js"></script>
    <script src="js/api-client.js"></script>
    <script>
        // Ratings page specific JS
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Try to load session data from API
                const sessionId = new URLSearchParams(window.location.search).get('sessionId');
                if (sessionId) {
                    // Load actual session data from API
                    const session = await getCurrentSession(); // This might not be implemented yet
                    loadSessionSummary(session);
                } else {
                    // Fallback to dummy data
                    await loadDummyData();
                    loadSessionSummary(dummyData.session);
                }

                await loadPastRatings();
            } catch (error) {
                console.error('Error loading session data:', error);
                // Still attach the form handler even if data loading fails
                loadSessionSummary(null); // Load with empty session
            }

            document.getElementById('rating-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitRating();
            });
        });

        function loadSessionSummary(sessionData) {
            // If no session data, use dummy data
            const session = sessionData || (dummyData && dummyData.session) || {
                skill: { name: 'Sample Skill' },
                teacher: { name: 'Sample Teacher' },
                startTime: new Date().toISOString()
            };

            const summaryEl = document.getElementById('session-summary');

            summaryEl.innerHTML = `
                <div class="summary-card">
                    <p><strong>Skill:</strong> ${session.skill?.name || 'Unknown'}</p>
                    <p><strong>With:</strong> ${session.teacher?.name || 'Unknown'}</p>
                    <p><strong>Date:</strong> ${new Date(session.startTime || session.startTime || new Date()).toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${new Date(session.startTime || session.startTime || new Date()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                </div>
            `;
        }

        async function loadPastRatings() {
            try {
                // Try to load ratings from API
                const ratings = await getCreditHistory(); // Using credit history as a proxy since ratings endpoint might not exist yet
                displayRatings(ratings);
            } catch (error) {
                console.warn('Failed to load ratings from API, using dummy data:', error);

                // Fallback to dummy data if API fails
                if (dummyData && dummyData.ratings) {
                    displayRatings(dummyData.ratings);
                } else {
                    document.getElementById('past-ratings').innerHTML = '<p>No past ratings available</p>';
                }
            }
        }

        function displayRatings(ratings) {
            const ratingsContainer = document.getElementById('past-ratings');
            ratingsContainer.innerHTML = '';

            if (!ratings || ratings.length === 0) {
                ratingsContainer.innerHTML = '<p>No past ratings available</p>';
                return;
            }

            ratings.forEach(rating => {
                const ratingEl = document.createElement('div');
                ratingEl.className = 'rating-card';
                ratingEl.innerHTML = `
                    <div class="rating-header">
                        <h4>${rating.skill?.name || rating.skill || 'Unknown Skill'} with ${rating.partner || 'Unknown Partner'}</h4>
                        <div class="rating-stars">
                            ${'★'.repeat(rating.stars || rating.rating || 0)}${'☆'.repeat(5 - (rating.stars || rating.rating || 0))}
                        </div>
                    </div>
                    <p class="rating-comment">${rating.comment || rating.review || 'No comment provided'}</p>
                    <small class="rating-date">${new Date(rating.date || new Date()).toLocaleDateString()}</small>
                `;
                ratingsContainer.appendChild(ratingEl);
            });
        }

        async function submitRating() {
            const rating = document.querySelector('input[name="rating"]:checked');
            const comment = document.getElementById('rating-comment').value;

            if (!rating) {
                alert('Please select a star rating.');
                return;
            }

            try {
                // Try to submit rating to API
                const sessionId = new URLSearchParams(window.location.search).get('sessionId');
                if (sessionId) {
                    await completeSession(sessionId, {
                        rating: parseInt(rating.value),
                        feedback: comment
                    });

                    alert('Rating submitted successfully!');
                    window.location.href = 'dashboard.html';
                } else {
                    // Fallback if no session ID is provided
                    alert('Rating recorded locally. Backend integration coming soon!');
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Failed to submit rating: ' + error.message);
            }
        }
    </script>
</body>
</html>
